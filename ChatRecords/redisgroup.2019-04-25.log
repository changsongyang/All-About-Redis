2019-04-25 09:52:11,080  鹏程@CMBC 分享链接:
 #每日分享 「链接」 Nginx 通过 Lua + Redis 实现动态封禁 IP
https://t.zsxq.com/qf6yzRf
2019-04-25 10:02:28,040  贾弘鸣@信产教育 说: 
好文👍
2019-04-25 10:03:04,698  王江华@好未来 说: 
好文👍
2019-04-25 10:04:12,029  邓伟@jit 说: 
定期获取，不是实时的
2019-04-25 10:05:34,285  木木@简寻 说: 
openresty确实好用
2019-04-25 10:15:17,173  roy@易科 说: 
主要ngx+lua 简单高效 做接口 性能也很赞
2019-04-25 10:16:54,222  明@汽车之家 说: 
学习lua的书有好的推荐没
2019-04-25 10:24:46,806  匪兵丙@云端漫行 说: 
原来用redis当内存数据库用.三台机器用openresty 撑起一天上亿次请救 .
2019-04-25 10:25:37,387  匪兵丙@云端漫行 说: 
另一个系统前面openresty ,后面redis-cluster.单nginx 进程压测20K/qps .

2019-04-25 10:27:38,435  邓伟@jit 说: 
平均RT是多少？
2019-04-25 10:28:47,036  邓伟@jit 说: 
每次请求都是成功了吗？有没有网络丢包呢？
2019-04-25 10:31:05,761  木木@简寻 说: 
[强]
2019-04-25 10:34:59,164  邓伟@jit 说: 
重要的是实施中遇到什么问题了
2019-04-25 11:06:22,225  鹏程@CMBC 说: 
@匪兵丙@云端漫行 开发运维中有什么经验分享吗？
2019-04-25 11:29:11,503  Slogen@didi 说: 
我有个问题啊,在执行aof重写的时候，父进程新的命令会写到aof重写缓冲区中，等子进程重写完整之后通知父进程把aof重写缓冲区中的数据写入新的aof文件 

如果在子进程重写完成之前，aof重写缓冲区已经满了
2019-04-25 11:29:43,093  Slogen@didi 说: 
这个时候redis会怎么处理啊
2019-04-25 11:47:46,646  张仕华@滴滴 说: 
写入的是一个aof_rewrite_buf_blocks,是一个链表,每个节点10M大小
2019-04-25 11:48:06,095  张仕华@滴滴 说: 
写满一个节点可以再申请
2019-04-25 11:49:17,251  鹏程@CMBC 说: 
我看是个list
2019-04-25 11:49:27,059  鹏程@CMBC 说: 
每次申请10M（代码写死的）
2019-04-25 11:50:16,916  鹏程@CMBC 说: 
会打日志提醒，每多10个倍数的时候。
2019-04-25 11:50:42,907  鹏程@CMBC 说: 
所以不会满，不存在满了后Redis怎么处理的问题
2019-04-25 11:50:58,208  鹏程@CMBC 说: 
看aofRewriteBufferAppend这个函数
2019-04-25 11:51:04,289  鹏程@CMBC 说: 
aof.c
2019-04-25 11:51:19,444  鹏程@CMBC 说: 
@张仕华@滴滴 说得对~
2019-04-25 11:52:38,033  Slogen@didi 说: 
sogar 不会满
2019-04-25 11:52:46,237  Slogen@didi 说: 
还是应该多看看源码[捂脸]
2019-04-25 11:52:54,913  Slogen@didi 说: 
谢谢俩位大佬
2019-04-25 12:05:26,574  鹏程@CMBC 说: 
客气客气，时间久也忘了现翻的...我明天每日分享发一个上个月看的还不错的源码分析文章，排版渣一些
2019-04-25 12:13:41,564  秦亚男@lagou 说: 
麻烦大佬解答一个问题
2019-04-25 12:14:13,077  秦亚男@lagou 说: 
这个incr没有对应的clientip，是不是redis内部做的操作呢
2019-04-25 12:29:41,746  秦亚男@lagou 说: 
这个我用monitor跑出来的数据
2019-04-25 12:44:38,442  张仕华@滴滴 说: 
客气了。这里边存是可以存了，但最后有一小部分数据还是需要主线程去刷盘，所以过程中会起管道去传一些数据到子线程，保证大部分数据由子线程去刷盘，以免主线程最后刷太多数据阻塞。
2019-04-25 12:45:16,115  张仕华@滴滴 说: 
其中管道传给子进程的部分是会从链表中摘掉的
2019-04-25 12:45:29,969  张仕华@滴滴 说: 
进程不是线程
2019-04-25 13:20:06,788  秦亚男@lagou 说: 
@张仕华@滴滴 您好，我现在在排查一个问题。我们线上使用的是redis一主一从+sentinel高可用的架构。现在有一个redis的从库，它的内存再不断升高，主库没问题。我怀疑有业务没有走sentinel直接连的这台redis从库在写数据。所以我用monitor命令监控了一下排除主库ip后的流量，然后看到有些incr和hset的命令打的标识是lua，这样我就查不到这些命令的来源是 哪里了。
2019-04-25 13:21:20,750  秦亚男@lagou 说: 
所以，我想问一下打了[0 lua]这样的标识的数据来源应该怎么查[捂脸]
2019-04-25 13:32:43,833  gukf@牛栏 说: 
看下网络连接就知道有没有其他机器连过来的了
2019-04-25 13:35:08,193  秦亚男@lagou 说: 
看了之后是有的，但是不知道他们具体在做什么操作。所以想到通过monitor来看一下
2019-04-25 13:35:57,922  秦亚男@lagou 说: 
现在发现写的操作都是带[0 lua]这样的标识的，所以就想问问群里的大佬。这个代表什么意思
2019-04-25 13:45:14,199  gukf@牛栏 说: 
0是dbid,后面那个应该代表同步的操作。
2019-04-25 14:03:28,924  张仕华@滴滴 说: 
monitor没用过.可以问问群里大佬们,一会我有空了也看下。你是想知道命令是哪个客户端执行的吧？
2019-04-25 14:06:25,882  秦亚男@lagou 说: 
是的
2019-04-25 14:06:59,653  鹏程@CMBC 说: 
其中dictid是c->db->id
2019-04-25 14:07:37,364  鹏程@CMBC 说: 
这种没法查，就是执行了lua，至于谁触发执行的monitor没有记录
2019-04-25 14:08:42,257  秦亚男@lagou 说: 
好吧。谢谢啦。@鹏程@CMBC 
2019-04-25 14:21:50,302  鹏程@CMBC 说: 
@秦亚男@lagou monitor有eval或者evalsha吗？
2019-04-25 14:24:05,539  秦亚男@lagou 说: 
您的意思是不是通过本地脚本执行的？
2019-04-25 14:27:34,541  鹏程@CMBC 说: 
lua一般就eval或者evalsha，不管是不是本地执行应该都有记录在monitor，你先搜搜日志有没有。
2019-04-25 14:28:56,862  秦亚男@lagou 说: 
我通过monitor命令过滤了一会儿是没发现的
2019-04-25 14:29:12,538  秦亚男@lagou 说: 
我再打开debug日志看看 
2019-04-25 14:32:43,887  鹏程@CMBC 说: 
@秦亚男@lagou 什么版本？
2019-04-25 14:34:04,874  秦亚男@lagou 说: 
2.8.11
2019-04-25 14:37:28,741  鹏程@CMBC 说: 
我看5.x是可以看到eval的，没看过2.8...
2019-04-25 15:01:23,549  张仕华@滴滴 说: 
我在5.0版本执行monitor的话是这个显示.第一条命令会有ip地址,后边两条是第一条中eval命令调用redis.call生成的,伪客户端, 所以打印dictid和lua
2019-04-25 15:02:05,654  张仕华@滴滴 说: 
图片是这个
2019-04-25 15:05:47,968  秦亚男@lagou 说: 
好的，了解了。应该是我这个redis版本太低了，打印的信息不全。
2019-04-25 15:36:45,363  洋烊@借贷宝 说: 
有人用了阿里云的redis么？关于eval的使用想请教一下，为什么我加了{tag}，然后key还是不在同一个slot
2019-04-25 15:38:12,216  洋烊@借贷宝 说: 
是不是我的tag加的不对
2019-04-25 15:40:24,617  洋烊@借贷宝 说: 
没事了
2019-04-25 17:45:24,529  chenssy@平安 说: 
请教各位大佬，这两个参数是什么意思加
2019-04-25 17:45:26,060  chenssy@平安 说: 
啊
2019-04-25 17:52:34,924  明@汽车之家 说: 
请看Redis 4.x cookbook 第5章[呲牙]
2019-04-25 17:58:43,424  arthur@baidu 说: 
是用于psync的参数，repl2 记录了上次同步的实例的repl id，每次跟新的实例同步时会设置成新的id
2019-04-25 18:02:10,717  arthur@baidu 说: 
为了解决master挂掉之后，提升slave为master的情况，其它slave能够继续 psync
2019-04-25 18:03:09,823  arthur@baidu 说: 
这个是 5.0.3 的代码
2019-04-25 18:29:10,845  明@汽车之家 说: 
[强]
2019-04-25 18:32:15,433  白馨@陌陌 说: 
* Redis tries to encode everything as little endian (but a few things that need
 * to be backward compatible are still in big endian) because most of the
 * production environments are little endian, and we have a lot of conversions
 * in a few places because ziplists, intsets, zipmaps, need to be endian-neutral
 * even in memory, since they are serialied on RDB files directly with a single
 * write(2) without other additional steps.
2019-04-25 18:32:21,263  白馨@陌陌 说: 
endian-neutral  这个怎么理解
2019-04-25 18:33:09,434  黄威@国美 说: 
大小端编码
2019-04-25 18:33:27,690  白馨@陌陌 说: 
endian-neutra
2019-04-25 18:33:30,231  白馨@陌陌 说: 
我说这个
2019-04-25 18:33:47,434  白馨@陌陌 说: 
哦
2019-04-25 18:33:57,164  白馨@陌陌 说: 
不是一个名词
2019-04-25 18:34:29,505  黄威@国美 说: 
恩恩，我觉得理解成小端编码更合适
2019-04-25 18:34:54,598  黄威@国美 说: 
虽然字面意思是中性编码
2019-04-25 18:36:36,461  黄威@国美 说: 
因为这些数据结构涉及到内存的直接操作，不同的处理器架构对内存地址访问有大小端问题
2019-04-25 18:37:28,851  黄威@国美 说: 
为了统一数据结构，即使是大端的处理器架构也使用小端结构来访问，我是这么理解的[微笑]
2019-04-25 18:38:06,524  白馨@陌陌 说: 
我知道这个 刚瞬间以为endian-neutra是个类似大小端的一个名词
2019-04-25 18:38:45,486  黄威@国美 说: 
只看这句话确实不好理解[捂脸]
2019-04-25 18:39:33,540  白馨@陌陌 说: 
[捂脸]
